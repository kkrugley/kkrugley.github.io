<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор развертки конусной обечайки</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .input-group {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100px;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .canvas-container {
            border: 1px solid #ddd;
            margin: 20px 0;
            overflow: auto;
            max-height: 600px;
        }
        canvas {
            display: block;
            background: white;
        }
        .info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .pages-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }
        .page {
            border: 2px solid #007bff;
            position: relative;
            margin-bottom: 40px;
        }
        .page-label {
            position: absolute;
            top: -20px;
            left: 0;
            background: #007bff;
            color: white;
            padding: 2px 8px;
            font-size: 12px;
            border-radius: 4px 4px 0 0;
        }
        .page-controls {
            position: absolute;
            bottom: -35px;
            left: 0;
            display: flex;
            gap: 5px;
        }
        .page-controls button {
            padding: 5px 10px;
            font-size: 12px;
            margin: 0;
        }
        .download-all-container {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                margin: 0;
                border: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Генератор развертки конусной обечайки</h1>
        
        <div class="controls">
            <div class="input-group">
                <label for="r1">Больший радиус R1 (мм):</label>
                <input type="number" id="r1" value="100" step="0.1" min="0.1">
            </div>
            <div class="input-group">
                <label for="r2">Меньший радиус R2 (мм):</label>
                <input type="number" id="r2" value="50" step="0.1" min="0.1">
            </div>
            <div class="input-group">
                <label for="height">Высота H (мм):</label>
                <input type="number" id="height" value="100" step="0.1" min="0.1">
            </div>
            <div class="input-group">
                <label>&nbsp;</label>
                <div>
                    <button onclick="generatePattern()">Сгенерировать развертку</button>
                    <button onclick="downloadImage()">Скачать полное изображение</button>
                </div>
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="warning" class="warning" style="display: none;"></div>
        <div id="info" class="info" style="display: none;"></div>

        <div class="canvas-container">
            <canvas id="canvas"></canvas>
        </div>

        <div id="download-all-container" class="download-all-container" style="display: none;">
            <h3>Скачивание всех листов А4</h3>
            <button id="download-all-btn" onclick="downloadAllPages()">Скачать все листы (с задержкой)</button>
            <div id="download-progress" class="progress" style="display: none;">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            <div id="download-status"></div>
        </div>

        <div id="pages-container" class="pages-container" style="display: none;"></div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // Масштаб: примерно 3.78 пикселей на мм (96 DPI)
        const scale = 3.779527559;
        
        // Размеры листа А4 в мм
        const A4_WIDTH = 210;
        const A4_HEIGHT = 297;
        const MARGIN = 10; // отступы в мм
        
        let currentPattern = null;
        let pageCanvases = [];
        
        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
            document.getElementById('warning').style.display = 'none';
            document.getElementById('info').style.display = 'none';
        }
        
        function showWarning(message) {
            document.getElementById('warning').innerHTML = message;
            document.getElementById('warning').style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }
        
        function showInfo(message) {
            document.getElementById('info').innerHTML = message;
            document.getElementById('info').style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }
        
        function calculatePattern(r1, r2, h) {
            // Исправленные формулы для развертки усеченного конуса
            const L = Math.sqrt(h * h + (r1 - r2) * (r1 - r2)); // образующая
            const R = r1 * L / (r1 - r2); // расстояние от вершины до большего основания
            const R_small = R - L; // расстояние от вершины до меньшего основания
            const angle = 2 * Math.PI * (r1 - r2) / L; // угол сектора в радианах
            
            return {
                L: L,
                R: R,
                R_small: R_small,
                angle: angle,
                angleDegrees: angle * 180 / Math.PI
            };
        }
        
        function generatePattern() {
            const r1 = parseFloat(document.getElementById('r1').value);
            const r2 = parseFloat(document.getElementById('r2').value);
            const h = parseFloat(document.getElementById('height').value);
            
            if (r1 <= 0 || r2 <= 0 || h <= 0) {
                showError('Все параметры должны быть больше нуля');
                return;
            }
            
            if (r1 <= r2) {
                showError('Больший радиус R1 должен быть больше меньшего радиуса R2');
                return;
            }
            
            // Расчет параметров развертки
            const pattern = calculatePattern(r1, r2, h);
            currentPattern = {...pattern, r1, r2, h};
            
            // Размеры canvas в пикселях
            const canvasWidth = Math.ceil((pattern.R * 2 + 50) * scale);
            const canvasHeight = Math.ceil((pattern.R + 50) * scale);
            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // Центр развертки
            const centerX = pattern.R * scale + 25 * scale;
            const centerY = 25 * scale;
            
            // Рисование развертки
            drawPattern(ctx, centerX, centerY, pattern, scale);
            
            // Информация о развертке
            const developmentWidth = pattern.R * Math.sin(pattern.angle);
            const developmentHeight = pattern.R - pattern.R_small;
            
            let info = `
                <strong>Параметры развертки:</strong><br>
                Образующая L = ${pattern.L.toFixed(2)} мм<br>
                Радиус большей дуги = ${pattern.R.toFixed(2)} мм<br>
                Радиус меньшей дуги = ${pattern.R_small.toFixed(2)} мм<br>
                Угол сектора = ${pattern.angleDegrees.toFixed(2)}°<br>
                Размеры развертки: ${developmentWidth.toFixed(0)} × ${developmentHeight.toFixed(0)} мм<br>
                Длина большей дуги = ${(2 * Math.PI * r1).toFixed(2)} мм<br>
                Длина меньшей дуги = ${(2 * Math.PI * r2).toFixed(2)} мм
            `;
            
            // Проверка помещения на А4
            if (developmentWidth > A4_WIDTH - 2*MARGIN || developmentHeight > A4_HEIGHT - 2*MARGIN) {
                const pagesX = Math.ceil(developmentWidth / (A4_WIDTH - 2*MARGIN));
                const pagesY = Math.ceil(developmentHeight / (A4_HEIGHT - 2*MARGIN));
                const totalPages = pagesX * pagesY;
                
                showWarning(`Развертка не помещается на лист А4. Потребуется ${totalPages} листов (${pagesX}×${pagesY})`);
                
                info += `<br><strong>Для печати потребуется ${totalPages} листов А4</strong>`;
                generateA4Pages();
                document.getElementById('download-all-container').style.display = 'block';
            } else {
                document.getElementById('pages-container').style.display = 'none';
                document.getElementById('download-all-container').style.display = 'none';
            }
            
            showInfo(info);
        }
        
        function drawPattern(context, centerX, centerY, pattern, drawScale) {
            // Очистка
            context.clearRect(0, 0, context.canvas.width, context.canvas.height);
            
            // Настройка стилей
            context.strokeStyle = '#000000';
            context.lineWidth = 1;
            context.fillStyle = 'none';
            
            // Рисование внешней дуги
            context.beginPath();
            context.arc(centerX, centerY, pattern.R * drawScale, 0, pattern.angle);
            context.stroke();
            
            // Рисование внутренней дуги
            context.beginPath();
            context.arc(centerX, centerY, pattern.R_small * drawScale, 0, pattern.angle);
            context.stroke();
            
            // Рисование боковых линий
            context.beginPath();
            context.moveTo(centerX + pattern.R_small * drawScale, centerY);
            context.lineTo(centerX + pattern.R * drawScale, centerY);
            context.stroke();
            
            context.beginPath();
            context.moveTo(
                centerX + pattern.R_small * drawScale * Math.cos(pattern.angle),
                centerY + pattern.R_small * drawScale * Math.sin(pattern.angle)
            );
            context.lineTo(
                centerX + pattern.R * drawScale * Math.cos(pattern.angle),
                centerY + pattern.R * drawScale * Math.sin(pattern.angle)
            );
            context.stroke();
            
            // Засечки для точности
            drawMeasurementMarks(context, centerX, centerY, pattern.R * drawScale, pattern.R_small * drawScale, pattern.angle);
        }
        
        function drawMeasurementMarks(context, centerX, centerY, radiusBig, radiusSmall, angle) {
            context.strokeStyle = '#ff0000';
            context.lineWidth = 0.5;
            
            const markInterval = Math.PI / 18; // 10 градусов
            for (let a = 0; a <= angle; a += markInterval) {
                const x1 = centerX + radiusBig * Math.cos(a);
                const y1 = centerY + radiusBig * Math.sin(a);
                const x2 = centerX + radiusSmall * Math.cos(a);
                const y2 = centerY + radiusSmall * Math.sin(a);
                
                context.beginPath();
                context.moveTo(x1, y1);
                context.lineTo(x1 - 10 * Math.cos(a), y1 - 10 * Math.sin(a));
                context.stroke();
                
                context.beginPath();
                context.moveTo(x2, y2);
                context.lineTo(x2 + 10 * Math.cos(a), y2 + 10 * Math.sin(a));
                context.stroke();
            }
        }
        
        function generateA4Pages() {
            if (!currentPattern) return;
            
            const container = document.getElementById('pages-container');
            container.innerHTML = '';
            container.style.display = 'flex';
            pageCanvases = [];
            
            const developmentWidth = currentPattern.R * Math.sin(currentPattern.angle);
            const developmentHeight = currentPattern.R - currentPattern.R_small;
            
            const pagesX = Math.ceil(developmentWidth / (A4_WIDTH - 2*MARGIN));
            const pagesY = Math.ceil(developmentHeight / (A4_HEIGHT - 2*MARGIN));
            
            for (let y = 0; y < pagesY; y++) {
                for (let x = 0; x < pagesX; x++) {
                    const pageCanvas = document.createElement('canvas');
                    pageCanvas.width = A4_WIDTH * scale;
                    pageCanvas.height = A4_HEIGHT * scale;
                    
                    const pageCtx = pageCanvas.getContext('2d');
                    
                    // Белый фон
                    pageCtx.fillStyle = 'white';
                    pageCtx.fillRect(0, 0, pageCanvas.width, pageCanvas.height);
                    
                    // Рамка листа
                    pageCtx.strokeStyle = '#ccc';
                    pageCtx.lineWidth = 1;
                    pageCtx.strokeRect(MARGIN * scale, MARGIN * scale, 
                                     (A4_WIDTH - 2*MARGIN) * scale, 
                                     (A4_HEIGHT - 2*MARGIN) * scale);
                    
                    // Смещение для части развертки
                    const offsetX = -x * (A4_WIDTH - 2*MARGIN) * scale;
                    const offsetY = -y * (A4_HEIGHT - 2*MARGIN) * scale;
                    
                    pageCtx.save();
                    pageCtx.translate(MARGIN * scale + offsetX, MARGIN * scale + offsetY);
                    
                    // Рисование части развертки
                    const centerX = currentPattern.R * scale + 25 * scale;
                    const centerY = 25 * scale;
                    drawPattern(pageCtx, centerX, centerY, currentPattern, scale);
                    
                    pageCtx.restore();
                    
                    // Подпись листа
                    pageCtx.fillStyle = '#000';
                    pageCtx.font = '12px Arial';
                    pageCtx.fillText(`Лист ${y * pagesX + x + 1}`, 5, 15);
                    pageCtx.fillText(`Строка ${y + 1}, Столбец ${x + 1}`, 5, 30);
                    
                    // Добавление в массив
                    pageCanvases.push(pageCanvas);
                    
                    // Обертка для страницы
                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'page';
                    
                    const label = document.createElement('div');
                    label.className = 'page-label';
                    label.textContent = `Лист ${y * pagesX + x + 1}`;
                    
                    const controls = document.createElement('div');
                    controls.className = 'page-controls';
                    
                    const downloadBtn = document.createElement('button');
                    downloadBtn.textContent = 'Скачать';
                    downloadBtn.onclick = () => downloadSinglePage(y * pagesX + x, pageCanvas);
                    
                    const printBtn = document.createElement('button');
                    printBtn.textContent = 'Печать';
                    printBtn.onclick = () => printSinglePage(pageCanvas);
                    
                    controls.appendChild(downloadBtn);
                    controls.appendChild(printBtn);
                    
                    pageDiv.appendChild(label);
                    pageDiv.appendChild(pageCanvas);
                    pageDiv.appendChild(controls);
                    container.appendChild(pageDiv);
                }
            }
        }
        
        function downloadSinglePage(index, pageCanvas) {
            const link = document.createElement('a');
            link.download = `cone_pattern_page_${index + 1}.png`;
            link.href = pageCanvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function printSinglePage(pageCanvas) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head><title>Печать листа</title></head>
                <body style="margin:0; padding:0;">
                    <img src="${pageCanvas.toDataURL()}" style="width:100%; height:100%;">
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        async function downloadAllPages() {
            if (pageCanvases.length === 0) return;
            
            const btn = document.getElementById('download-all-btn');
            const progress = document.getElementById('download-progress');
            const progressBar = document.getElementById('progress-bar');
            const status = document.getElementById('download-status');
            
            btn.disabled = true;
            progress.style.display = 'block';
            status.textContent = 'Начинаем скачивание...';
            
            for (let i = 0; i < pageCanvases.length; i++) {
                try {
                    const link = document.createElement('a');
                    link.download = `cone_pattern_page_${i + 1}.png`;
                    link.href = pageCanvases[i].toDataURL('image/png');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    const progress_percent = ((i + 1) / pageCanvases.length) * 100;
                    progressBar.style.width = progress_percent + '%';
                    status.textContent = `Скачано ${i + 1} из ${pageCanvases.length} листов`;
                    
                    // Задержка между скачиваниями (важно для браузеров)
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                } catch (error) {
                    status.textContent = `Ошибка при скачивании листа ${i + 1}: ${error.message}`;
                    break;
                }
            }
            
            btn.disabled = false;
            status.textContent = 'Скачивание завершено!';
            setTimeout(() => {
                progress.style.display = 'none';
                status.textContent = '';
            }, 3000);
        }
        
        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'cone_pattern_full.png';
            link.href = canvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Генерация при загрузке страницы
        window.onload = function() {
            generatePattern();
        };
    </script>
</body>
</html>
